<template>
  <div class="animated fadeIn" v-permission="'POLICY_MANAGEMENT'">
    <div id="vulnerabilityPolicyToolbar" class="bs-table-custom-toolbar"></div>
    <bootstrap-table
      ref="table"
      :columns="columns"
      :data="data"
      :options="options"
      @on-load-success="tableLoaded">
    </bootstrap-table>
  </div>
</template>

<script>
  import xssFilters from "xss-filters";
  import i18n from "../../i18n";
  import common from "../../shared/common";
  import permissionsMixin from "../../mixins/permissionsMixin";
  import $ from "jquery";
  import BootstrapToggle from "vue-bootstrap-toggle";
  import bootstrapTableMixin from "../../mixins/bootstrapTableMixin";
  import BInputGroupFormInput from "../../forms/BInputGroupFormInput";
  import {loadUserPreferencesForBootstrapTable} from "@/shared/utils";

  export default {
    mixins: [permissionsMixin, bootstrapTableMixin],
    components: {
    },
    methods: {
      apiUrl: function () {
        return `${this.$api.BASE_URL}/${this.$api.URL_POLICY}/vulnerability`;
      },
      tableLoaded: function(data) {
        if (data && Object.prototype.hasOwnProperty.call(data, "total")) {
          this.$emit('total', data.total);
        } else {
          this.$emit('total', '?');
        }
      },
      refreshTable: function() {
        this.$refs.table.refresh({
          url: this.apiUrl(),
          silent: true
        });
      },
      initializeTooltips: function () {
        $('[data-toggle="tooltip"]').tooltip();
      },
      onLoadSuccess: function () {
        loadUserPreferencesForBootstrapTable(this, "VulnerabilityPolicyList", this.$refs.table.columns);
      }
    },
    data() {
      return {
        columns: [
          {
            title: this.$t('message.name'),
            field: "name",
            sortable: true,
            formatter(value, row, index) {
              return xssFilters.inHTMLData(common.valueWithDefault(value, ""));
            }
          },
          {
            title: this.$t('message.author'),
            field: "author",
            sortable: true,
            formatter(value, row, index) {
              return xssFilters.inHTMLData(common.valueWithDefault(value, "-"));
            }
          },
          {
            title: this.$t('message.validFrom'),
            field: "validFrom",
            sortable: true,
            formatter(value, row, index) {
              return (typeof value !== 'undefined' && value != null) ? common.formatTimestamp(Math.trunc(value * 1000)) : "-";
            }
          },
          {
            title: this.$t('message.validUntil'),
            field: "validUntil",
            sortable: true,
            formatter(value, row, index) {
              return (typeof value !== 'undefined' && value != null) ? common.formatTimestamp(Math.trunc(value * 1000)) : "-";
            }
          },
          {
            title: this.$t('message.created'),
            field: "created",
            sortable: true,
            formatter(value, row, index) {
              return (typeof value !== 'undefined' && value != null) ? common.formatTimestamp(Math.trunc(value * 1000)) : "-";
            }
          },
          {
            title: this.$t('message.updated'),
            field: "updated",
            sortable: true,
            formatter(value, row, index) {
              return (typeof value !== 'undefined' && value != null) ? common.formatTimestamp(Math.trunc(value * 1000)) : "-";
            }
          }
        ],
        data: [],
        options: {
          onPostBody: this.initializeTooltips,
          search: true,
          showColumns: true,
          showRefresh: true,
          pagination: true,
          silentSort: false,
          sidePagination: 'server',
          queryParamsType: 'pageSize',
          pageList: '[10, 25, 50, 100]',
          pageSize: (localStorage && localStorage.getItem("VulnerabilityPolicyListPageSize") !== null) ? Number(localStorage.getItem("VulnerabilityPolicyListPageSize")) : 10,
          sortName: (localStorage && localStorage.getItem("VulnerabilityPolicyListSortName") !== null) ? localStorage.getItem("VulnerabilityPolicyListSortName") : undefined,
          sortOrder: (localStorage && localStorage.getItem("VulnerabilityPolicyListSortOrder") !== null) ? localStorage.getItem("VulnerabilityPolicyListSortOrder") : undefined,
          icons: {
            refresh: 'fa-refresh'
          },
          detailView: true,
          detailViewIcon: false,
          detailViewByClick: true,
          detailFormatter: (index, row) => {
            return this.vueFormatter({
              i18n,
              template: `
                <b-row class="expanded-row">
                  <b-col sm="6">
                    <b-form-group id="fieldset-1" :label="this.$t('message.conditions')" label-for="imput-1">
                      <b-form-textarea id="input-1" v-model="conditions" rows="4" disabled class="form-control disabled" readonly trim />
                    </b-form-group>
                    <b-form-group id="fieldset-2" :label="this.$t('message.ratings')" label-for="input-2">
                      <b-form-textarea id="input-2" v-model="ratings" rows="5" disabled class="form-control disabled" trim />
                    </b-form-group>
                  </b-col>
                  <b-col sm="6">
                    <b-form-group id="fieldset-1" :label="this.$t('message.description')" label-for="input-1">
                      <b-form-textarea id="input-1" v-model="this.policy.description" disabled class="form-control disabled" trim />
                    </b-form-group>
                    <b-form-group id="fieldset-2" :label="this.$t('message.analysis')" label-for="input-2">
                      <b-form-textarea id="input-2" v-model="analysis" rows="5" disabled class="form-control disabled" readonly trim />
                    </b-form-group>  
                  </b-col>
                </b-row>
              `,
              data() {
                return {
                  policy: row,
                  conditions: JSON.stringify(row.conditions),
                  ratings: JSON.stringify(row.ratings),
                  analysis: JSON.stringify(row.analysis),
                }
              },
              components: {
                BootstrapToggle,
                BInputGroupFormInput
              }
            })
          },
          onExpandRow: this.vueFormatterInit,
          toolbar: '#vulnerabilityPolicyToolbar',
          responseHandler: function (res, xhr) {
            res.total = xhr.getResponseHeader("X-Total-Count");
            return res;
          },
          url: this.apiUrl(),
          onPageChange: ((number, size) => {
            if (localStorage) {
              localStorage.setItem("VulnerabilityPolicyListPageSize", size.toString())
            }
          }),
          onColumnSwitch: ((field, checked) => {
            if (localStorage) {
              localStorage.setItem("VulnerabilityPolicyListShow"+common.capitalize(field), checked.toString())
            }
          }),
          onSort: ((name, order) => {
            if (localStorage) {
              localStorage.setItem("VulnerabilityPolicyListSortName", name);
              localStorage.setItem("VulnerabilityPolicyListSortOrder", order);
            }
          })
        }
      };
    }
  };
</script>
